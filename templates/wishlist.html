{% extends "base.html" %}

{% block title %}Мои Wishlists{% endblock %}

{% block content %}
<div class="main-layout">
    <!-- Левая часть: создание и список вишлистов -->
    <div class="content">
        <div class="card" style="margin-bottom: 3rem;">
            <h2 style="margin-top:0;">Создать новый список</h2>
            <form method="POST" action="/wishlist/create" style="display:flex; flex-direction:column; gap:0.8rem;">
                <input 
                    type="text" 
                    name="title" 
                    placeholder="Например: День рождения 2026" 
                    required 
                    autofocus
                    style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;"
                >
                <textarea 
                    name="description" 
                    placeholder="Описание (необязательно)" 
                    rows="2"
                    style="padding:0.6rem; border:1px solid #d1d5db; border-radius:6px;"
                ></textarea>
                <button type="submit" style="padding:0.7rem; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer;">Создать список</button>
            </form>
        </div>

        {% if wishlists %}
        <h2 style="margin-bottom:1.5rem;">Ваши списки</h2>
        <div class="grid">
            {% for wl in wishlists %}
            <a href="/wishlist/{{ wl.id }}" style="text-decoration:none; color:inherit;">
                <div class="card">
                    <h3 style="margin-top:0;">{{ wl.title }}</h3>
                    {% if wl.description %}
                    <p style="color:#4b5563; margin:0.6rem 0;">{{ wl.description | truncate(100) }}</p>
                    {% endif %}
                    <div style="margin-top:1rem; font-size:0.9rem; color:#9ca3af;">
                        Создан: {{ wl.created_at | truncate(10, True, '') }}
                        {% if wl.is_shared %}
                        <span style="color:#10b981; margin-left:0.8rem;">• публичный</span>
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align:center; padding:4rem 0; color:#9ca3af;">
            У вас пока нет списков желаний<br>
            Создайте первый выше ↑
        </div>
        {% endif %}
    </div>

    <!-- Правая часть: календарь -->
    <aside class="sidebar">
        <div class="calendar-header">
            <button onclick="prevMonth()">←</button>
            <h3 id="monthYear">Январь 2026</h3>
            <button onclick="nextMonth()">→</button>
        </div>

        <div class="calendar-grid" id="calendarDays"></div>
    </aside>
</div>

<script>
    let currentDate = new Date(); // текущая дата
    const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь",
                        "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
    const colors = ["#ef4444", "#3b82f6", "#10b981", "#f59e0b", "#8b5cf6", "#ec4899", "#14b8a6"];

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        document.getElementById("monthYear").textContent = monthNames[month] + " " + year;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay() || 7;

        const calendarDays = document.getElementById("calendarDays");
        calendarDays.innerHTML = '';

        // Названия дней недели
        ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'].forEach(day => {
            const div = document.createElement('div');
            div.className = 'calendar-day-name';
            div.textContent = day;
            calendarDays.appendChild(div);
        });

        // Пустые дни
        for (let i = 1; i < startingDayOfWeek; i++) {
            const div = document.createElement('div');
            div.className = 'calendar-day empty';
            calendarDays.appendChild(div);
        }

        // Дни месяца
        for (let day = 1; day <= daysInMonth; day++) {
            const div = document.createElement('div');
            div.className = 'calendar-day';
            div.textContent = day;

            const today = new Date();
            if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                div.classList.add('today');
            }

            div.onclick = function() {
                const selectedDate = `${year}-${String(month + 1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                window.location.href = `/calendar/add?date=${selectedDate}`;
            };

            calendarDays.appendChild(div);
        }

        loadEvents(year, month + 1);
    }

    async function loadEvents(year, month) {
        try {
            const response = await fetch(`/calendar/events/${year}/${month}`);
            const events = await response.json();

            document.querySelectorAll('.calendar-day').forEach(day => {
                const dayNum = day.textContent.trim();
                if (events[dayNum]) {
                    day.classList.add('has-events');
                    const dotsContainer = document.createElement('div');
                    dotsContainer.className = 'event-dots';

                    const count = events[dayNum];
                    for (let i = 0; i < Math.min(count, colors.length); i++) {
                        const dot = document.createElement('span');
                        dot.className = 'event-dot';
                        dot.style.backgroundColor = colors[i];
                        dotsContainer.appendChild(dot);
                    }

                    if (count > colors.length) {
                        const more = document.createElement('span');
                        more.textContent = `+${count - colors.length}`;
                        more.style.fontSize = '0.7rem';
                        more.style.color = '#ef4444';
                        dotsContainer.appendChild(more);
                    }

                    day.appendChild(dotsContainer);
                }
            });
        } catch (error) {
            console.error("Ошибка загрузки событий:", error);
        }
    }

    function prevMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    renderCalendar();
</script>
{% endblock %}
